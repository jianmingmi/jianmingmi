<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="&lt;p&gt;git底层原理&lt;/p&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>git底层原理 | Mijm Blog</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 6.3.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Git/" rel="tag">Git</a></div><div class="post-time">2022-06-30</div></div></div><div class="container post-header"><h1>git底层原理</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Git%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">Git的底层原理:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Blob-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.</span> <span class="toc-text">Blob 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tree-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.2.</span> <span class="toc-text">Tree 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Commit-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.3.</span> <span class="toc-text">Commit 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E8%BF%87%E6%9D%A5%E7%9C%8B%E7%9C%8BCommit-%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.4.</span> <span class="toc-text">反过来看看Commit 对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text">传输协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fetch"><span class="toc-number">2.1.</span> <span class="toc-text">Fetch:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Push"><span class="toc-number">2.2.</span> <span class="toc-text">Push:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">引用:</span></a></li></ol></details></div><div class="container post-content"><p>git底层原理</p>
<span id="more"></span>

<h2 id="Git的底层原理"><a href="#Git的底层原理" class="headerlink" title="Git的底层原理:"></a>Git的底层原理:</h2><h3 id="Blob-对象"><a href="#Blob-对象" class="headerlink" title="Blob 对象"></a>Blob 对象</h3><p>git在本质上就是一个键值对(key-value)的数据库. key是根据内容计算出来的hash值. value则是你需要存储的数据. 你可以使用<code>git hash-object</code>来确认一段数据的key.<br>在此之前, 请重新建一个新的git仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line"><span class="built_in">mkdir</span> test-git2</span><br><span class="line"><span class="built_in">cd</span> test-git2</span><br><span class="line">git init</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;test content&#x27;</span> | git hash-object -w --stdin</span><br><span class="line"><span class="comment"># d670460b4b4aece5915caf5c68d12f560a9fe3e4</span></span><br></pre></td></tr></table></figure>
<p>你这时候会发现你的<code>.git/objects</code>目录下面多了一个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l .git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4</span><br><span class="line"><span class="comment"># -r--r--r-- 1 cy cy 32 Feb 11 13:19 .git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4</span></span><br></pre></td></tr></table></figure>
<p>在这个文件中, 存储的就是一些元信息和test content这个文件内容. 这个文件具体的内容, 可以查看<a target="_blank" rel="noopener" href="https://git-scm.com/book/zh/v2/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-Git-%E5%AF%B9%E8%B1%A1#_%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8">对象存储</a><br>存储完了之后, 你也可以用<code>git cat-file</code>命令读取它</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p d670460b4b4aece5915caf5c68d12f560a9fe3e4</span><br><span class="line"><span class="comment"># test content</span></span><br></pre></td></tr></table></figure>
<p>你现在应该已经能初步理解git是如何存储信息的了. 任意数据你都可以存到git里. 它是最原始的信息, 我们把这种对象称之为<code>blob object</code></p>
<h3 id="Tree-对象"><a href="#Tree-对象" class="headerlink" title="Tree 对象"></a>Tree 对象</h3><p>敏锐的同学应该已经发现了, 那文件名存在哪里? 答案是git会单独用另外一种object来存储</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git update-index --add --cacheinfo 100644 d670460b4b4aece5915caf5c68d12f560a9fe3e4 test.txt</span><br></pre></td></tr></table></figure>

<p>此时你使用运行<code>git status</code>会发现Index区域变了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line"><span class="comment"># HEAD detached from f8f34a1 </span></span><br><span class="line"><span class="comment"># Changes to be committed: </span></span><br><span class="line"><span class="comment">#   (use &quot;git restore --staged &lt;file&gt;...&quot; to unstage) </span></span><br><span class="line"><span class="comment">#     new file:   test.txt </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># Changes not staged for commit: </span></span><br><span class="line"><span class="comment">#   (use &quot;git add/rm &lt;file&gt;...&quot; to update what will be committed) </span></span><br><span class="line"><span class="comment">#   (use &quot;git restore &lt;file&gt;...&quot; to discard changes in working directory) </span></span><br><span class="line"><span class="comment">#     deleted:    test.txt </span></span><br><span class="line"><span class="comment"># </span></span><br></pre></td></tr></table></figure>

<p><code>git add</code>实际上就是<code>git hash-object</code>和<code>git update-index</code>的组合. <code>实际上是把d670460b4b4aece5915caf5c68d12f560a9fe3e4</code> 这个object复制到了Index区域</p>
<p>接下来就可以使用<code>git write-tree</code>命令.将Index区域的内容写入到一个<code>Tree Object</code>中.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git write-tree</span><br><span class="line"><span class="comment">#  80865964295ae2f11d27383e5f9c0b58a8ef21da</span></span><br><span class="line">git cat-file -p 80865964295ae2f11d27383e5f9c0b58a8ef21da</span><br><span class="line"><span class="comment"># 100644 blob d670460b4b4aece5915caf5c68d12f560a9fe3e4 test.txt</span></span><br></pre></td></tr></table></figure>

<h3 id="Commit-对象"><a href="#Commit-对象" class="headerlink" title="Commit 对象"></a>Commit 对象</h3><p>有了树对象, 我们就可以创建一个提交对象了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;first commit&#x27;</span> | git commit-tree 80865964295ae2f11d27383e5f9c0b58a8ef21da</span><br><span class="line">e137f356afa88b2b8984c4105326d74826a8c5c1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> e137f356afa88b2b8984c4105326d74826a8c5c1</span><br><span class="line"></span><br><span class="line"><span class="comment"># commit e137f356afa88b2b8984c4105326d74826a8c5c1 </span></span><br><span class="line"><span class="comment"># Author: Cheng Yang &lt;chengyang@xiaomi.com&gt; </span></span><br><span class="line"><span class="comment"># Date:   Fri Feb 11 19:39:09 2022 +0800 </span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#     first commit </span></span><br></pre></td></tr></table></figure>

<p>至此, 我们在不使用<code>git add</code>和<code>git commit</code>的情况下, 创建了一个提交</p>
<h3 id="反过来看看Commit-对象"><a href="#反过来看看Commit-对象" class="headerlink" title="反过来看看Commit 对象"></a>反过来看看<code>Commit 对象</code></h3><p>git里, 万物皆对象.凡是有hash的东西一定是一个对象. 那么我们来从后往前看看, 一个提交里到底有什么?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p e137f356afa88b2b8984c4105326d74826a8c5c1</span><br><span class="line"><span class="comment"># tree 80865964295ae2f11d27383e5f9c0b58a8ef21da </span></span><br><span class="line"><span class="comment"># author Cheng Yang &lt;chengyang@xiaomi.com&gt; 1644579549 +0800 </span></span><br><span class="line"><span class="comment"># committer Cheng Yang &lt;chengyang@xiaomi.com&gt; 1644579549 +0800 </span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># first commit </span></span><br></pre></td></tr></table></figure>

<p>你会发现, <code>Commit Object</code>也不过是一个普通object, 只不过内容是存储了提交者, 作者, 时间戳, 以及这个提交所包含的<code>Tree Object</code>. 一如你运行<code>git log</code>所看到的内容</p>
<p>那么我们再次运行<code>cat-file</code>查看这个<code>Tree Object</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p 80865964295ae2f11d27383e5f9c0b58a8ef21da </span><br><span class="line"><span class="comment"># 100644 blob d670460b4b4aece5915caf5c68d12f560a9fe3e4 test.txt</span></span><br></pre></td></tr></table></figure>

<p>很显然, 和刚才一样, 这个<code>Tree Object</code>的意思是包含<code>test.txt</code>这个文件, 文件内容存储在<code>d670460b4b4aece5915caf5c68d12f560a9fe3e4</code> 这个对象中<br>那么再继续看看这个对象</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p d670460b4b4aece5915caf5c68d12f560a9fe3e4 </span><br><span class="line"><span class="comment"># test content </span></span><br></pre></td></tr></table></figure>

<p>所以, 这个<code>Commit Object</code>包含了一个<code>Tree Object</code>, 而这个<code>Tree Object</code>包含了一个叫<code>test.txt</code>, 而<code>test.txt</code>文件里的内容是<code>test content</code>.<br>这里你会注意到, 我们的硬盘中甚至从头到尾都没有出现过一个叫<code>test.txt</code>的文件</p>
<h2 id="传输协议"><a href="#传输协议" class="headerlink" title="传输协议"></a>传输协议</h2><h3 id="Fetch"><a href="#Fetch" class="headerlink" title="Fetch:"></a>Fetch:</h3><p>理解git的传输协议, 我们可以使用<code>GIT_TRACE_PACKET</code>宏, 让git能自动打印出所有发送的网络包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line"><span class="built_in">mkdir</span> fetch-test</span><br><span class="line"><span class="built_in">cd</span> fetch-test</span><br><span class="line"></span><br><span class="line">GIT_TRACE_PACKET=1 git -c protocol.version=1 <span class="built_in">clone</span> /tmp/test-git1</span><br></pre></td></tr></table></figure>

<p>这个地方设置<code>protocol.version=1</code>的原因是因为git默认使用v2协议还是2020年的事, 相当数量的服务器并未支持v2协议, 而且v2协议协商过程会稍微复杂一些, 所以我们使用比较常见的v1先来解释git如何远程传输数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Cloning into <span class="string">&#x27;test-git1&#x27;</span>... </span><br><span class="line">20:09:07.319608 pkt-line.c:80           packet:  upload-pack&gt; version 1 </span><br><span class="line">20:09:07.319670 pkt-line.c:80           packet:        <span class="built_in">clone</span>&lt; version 1 </span><br><span class="line">20:09:07.319761 pkt-line.c:80           packet:  upload-pack&gt; 4cf4037e6bb2016fe30d1af96788ef6f8499d516 HEAD\0multi_ack thin-pack side-band side-band-64k ofs-delta shallow deepen-since deepen-not deepen-relative no-progress include-tag multi_ack_detailed allow-tip-sha1-in-want allow-reachable-sha1-in-want symref=HEAD:refs/heads/master object-format=sha1 agent=git/2.35.1 </span><br><span class="line">20:09:07.319874 pkt-line.c:80           packet:  upload-pack&gt; 4cf4037e6bb2016fe30d1af96788ef6f8499d516 refs/heads/master </span><br><span class="line">20:09:07.319886 pkt-line.c:80           packet:  upload-pack&gt; 0000 </span><br><span class="line">20:09:07.319908 pkt-line.c:80           packet:        <span class="built_in">clone</span>&lt; 4cf4037e6bb2016fe30d1af96788ef6f8499d516 HEAD\0multi_ack thin-pack side-band side-band-64k ofs-delta shallow deepen-since deepen-not deepen-relative no-progress include-tag multi_ack_detailed allow-tip-sha1-in-want allow-reachable-sha1-in-want symref=HEAD:refs/heads/master object-format=sha1 agent=git/2.35.1 </span><br><span class="line">20:09:07.319925 pkt-line.c:80           packet:        <span class="built_in">clone</span>&lt; 4cf4037e6bb2016fe30d1af96788ef6f8499d516 refs/heads/master </span><br><span class="line">20:09:07.319929 pkt-line.c:80           packet:        <span class="built_in">clone</span>&lt; 0000 </span><br><span class="line"><span class="keyword">done</span>. </span><br><span class="line">20:09:07.321498 pkt-line.c:80           packet:        <span class="built_in">clone</span>&gt; 0000 </span><br><span class="line">20:09:07.321532 pkt-line.c:80           packet:  upload-pack&lt; 0000</span><br></pre></td></tr></table></figure>

<p><code>&lt;</code>表示收到, <code>&gt;</code>表示发送. <code>upload-pack&gt;</code>的意思就是<code>upload-pack</code>发送了数据. 而<code>upload-pack</code>是服务端上的进程, 其实意思也就是服务端发送了数据.<br>在协商协议版本后, 远程服务器发送的第一项数据是一些元数据和能力, 主要是告诉客户端, 服务端支持哪些功能. 在此处我们不深入此处. 而第二项是最重要的<br><code>4cf4037e6bb2016fe30d1af96788ef6f8499d516 refs/heads/master</code><br>这个实际上是在告诉客户端, 服务端所拥有的所有<code>refs</code>.在此处我们的服务器只有<code>master</code>这么一个分支, 它指向<code>4cf4037e6bb2016fe30d1af96788ef6f8499d516</code> 这个<code>Commit Object</code>. 那么后面的传输信息也很好理解了. 就是客户端在告诉服务器, 我需要的是<code>refs/heads/master</code>这个<code>ref</code>上的所有内容.<br><code>clone</code>的过程比较简单, 那么增量<code>fetch</code>呢? 我们不妨给<code>test-git1</code>添加一个change</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/test-git1</span><br><span class="line"><span class="built_in">echo</span> 3 &gt; 1.txt</span><br><span class="line">git commit -a -s -m <span class="string">&quot;3rd change&quot;</span></span><br></pre></td></tr></table></figure>

<p>此时我们再执行fetch</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/fetch-test/test-git1</span><br><span class="line">GIT_TRACE_PACKET=1 git -c protocol.version=1 fetch</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">20:13:55.779809 pkt-line.c:80           packet:  upload-pack&gt; version 1 </span><br><span class="line">20:13:55.779937 pkt-line.c:80           packet:        fetch&lt; version 1 </span><br><span class="line">20:13:55.780221 pkt-line.c:80           packet:  upload-pack&gt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 HEAD\0multi_ack thin-pack side-band side-band-64k ofs-delta shallow deepen-since deepen-not deepen-relative no-progress include-tag multi_ack_detailed allow-tip-sha1-in-want allow-reachable-sha1-in-want symref=HEAD:refs/heads/master object-format=sha1 agent=git/2.35.1 </span><br><span class="line">20:13:55.780500 pkt-line.c:80           packet:  upload-pack&gt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 refs/heads/master </span><br><span class="line">20:13:55.780531 pkt-line.c:80           packet:  upload-pack&gt; 0000 </span><br><span class="line">20:13:55.780549 pkt-line.c:80           packet:        fetch&lt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 HEAD\0multi_ack thin-pack side-band side-band-64k ofs-delta shallow deepen-since deepen-not deepen-relative no-progress include-tag multi_ack_detailed allow-tip-sha1-in-want allow-reachable-sha1-in-want symref=HEAD:refs/heads/master object-format=sha1 agent=git/2.35.1 </span><br><span class="line">20:13:55.780596 pkt-line.c:80           packet:        fetch&lt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 refs/heads/master </span><br><span class="line">20:13:55.780616 pkt-line.c:80           packet:        fetch&lt; 0000 </span><br><span class="line">20:13:55.781535 pkt-line.c:80           packet:        fetch&gt; want 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 multi_ack_detailed side-band-64k thin-pack include-tag ofs-delta deepen-since deepen-not agent=git/2.35.1 </span><br><span class="line">20:13:55.781553 pkt-line.c:80           packet:        fetch&gt; 0000 </span><br><span class="line">20:13:55.781617 pkt-line.c:80           packet:        fetch&gt; have 4cf4037e6bb2016fe30d1af96788ef6f8499d516 </span><br><span class="line">20:13:55.781612 pkt-line.c:80           packet:  upload-pack&lt; want 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 multi_ack_detailed side-band-64k thin-pack include-tag ofs-delta deepen-since deepen-not agent=git/2.35.1 </span><br><span class="line">20:13:55.781628 pkt-line.c:80           packet:        fetch&gt; have 889cc4292ce266e4607fd12aecb482cb89b1430d </span><br><span class="line">20:13:55.781635 pkt-line.c:80           packet:        fetch&gt; <span class="keyword">done</span> </span><br><span class="line">20:13:55.781800 pkt-line.c:80           packet:  upload-pack&lt; 0000 </span><br><span class="line">20:13:55.781819 pkt-line.c:80           packet:  upload-pack&lt; have 4cf4037e6bb2016fe30d1af96788ef6f8499d516 </span><br><span class="line">20:13:55.781944 pkt-line.c:80           packet:  upload-pack&gt; ACK 4cf4037e6bb2016fe30d1af96788ef6f8499d516 common </span><br><span class="line">20:13:55.781971 pkt-line.c:80           packet:  upload-pack&lt; have 889cc4292ce266e4607fd12aecb482cb89b1430d </span><br><span class="line">20:13:55.782004 pkt-line.c:80           packet:        fetch&lt; ACK 4cf4037e6bb2016fe30d1af96788ef6f8499d516 common </span><br><span class="line">20:13:55.782061 pkt-line.c:80           packet:  upload-pack&gt; ACK 889cc4292ce266e4607fd12aecb482cb89b1430d common </span><br><span class="line">20:13:55.782094 pkt-line.c:80           packet:  upload-pack&lt; <span class="keyword">done</span> </span><br><span class="line">20:13:55.782109 pkt-line.c:80           packet:  upload-pack&gt; ACK 889cc4292ce266e4607fd12aecb482cb89b1430d </span><br><span class="line">20:13:55.782122 pkt-line.c:80           packet:        fetch&lt; ACK 889cc4292ce266e4607fd12aecb482cb89b1430d common </span><br><span class="line">20:13:55.782151 pkt-line.c:80           packet:        fetch&lt; ACK 889cc4292ce266e4607fd12aecb482cb89b1430d </span><br><span class="line">20:13:55.784146 pkt-line.c:80           packet:     sideband&lt; \2Enumerating objects: 5, <span class="keyword">done</span>. </span><br><span class="line">remote: Enumerating objects: 5, <span class="keyword">done</span>. </span><br><span class="line">20:13:55.784171 pkt-line.c:80           packet:     sideband&lt; \2Counting objects:  20% (1/5)\15 </span><br><span class="line">20:13:55.784180 pkt-line.c:80           packet:     sideband&lt; \2Counting objects:  40% (2/5)\15 </span><br><span class="line">20:13:55.784193 pkt-line.c:80           packet:     sideband&lt; \2Counting objects:  60% (3/5)\15 </span><br><span class="line">20:13:55.784200 pkt-line.c:80           packet:     sideband&lt; \2Counting objects:  80% (4/5)\15 </span><br><span class="line">20:13:55.784208 pkt-line.c:80           packet:     sideband&lt; \2Counting objects: 100% (5/5)\15Counting objects: 100% (5/5), <span class="keyword">done</span>. </span><br><span class="line">remote: Counting objects: 100% (5/5), <span class="keyword">done</span>. </span><br><span class="line">20:13:55.784401 pkt-line.c:80           packet:     sideband&lt; \2Total 3 (delta 0), reused 0 (delta 0), pack-reused 0 </span><br><span class="line">remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0 </span><br><span class="line">20:13:55.784421 pkt-line.c:80           packet:     sideband&lt; PACK ... </span><br><span class="line">20:13:55.784526 pkt-line.c:80           packet:  upload-pack&gt; 0000 </span><br><span class="line">20:13:55.784575 pkt-line.c:80           packet:     sideband&lt; 0000 </span><br><span class="line">Unpacking objects: 100% (3/3), 360 bytes | 360.00 KiB/s, <span class="keyword">done</span>. </span><br><span class="line">From /tmp/test-git1 </span><br><span class="line">   4cf4037..3fb2316  master     -&gt; origin/master </span><br></pre></td></tr></table></figure>

<p>最开始, 仍旧是服务器发送了他拥有的<code>refs</code><br><code>upload-pack&gt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 refs/heads/master</code><br>此时, 客户端收到了之后, 就和自己的<code>refs/heads/master</code>做对比. 它告诉了服务器, 我需要哪个commit, 已经有了哪个commit</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">20:13:55.781535 pkt-line.c:80           packet:        fetch&gt; want 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 multi_ack_detailed  </span><br><span class="line">20:13:55.781553 pkt-line.c:80           packet:        fetch&gt; 0000 </span><br><span class="line">20:13:55.781617 pkt-line.c:80           packet:        fetch&gt; have 4cf4037e6bb2016fe30d1af96788ef6f8499d516 </span><br><span class="line">20:13:55.781628 pkt-line.c:80           packet:        fetch&gt; have 889cc4292ce266e4607fd12aecb482cb89b1430d</span><br></pre></td></tr></table></figure>

<p>这时候, git服务器的最优做法, 是指发送客户端没有的东西, 而不是发送整个的<code>refs/heads/master</code><br>接下来的<code>Enumerating Objects</code>和<code>Couting Objects</code>都是在整理”服务端有, 客户端没有的东西”. 并且发送回来.</p>
<h3 id="Push"><a href="#Push" class="headerlink" title="Push:"></a>Push:</h3><p>push的过程其实相对来说就是fetch的逆向操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/fetch-test/test-git1</span><br><span class="line">git checkout origin/master</span><br><span class="line"><span class="built_in">echo</span> 4 &gt; 1.txt</span><br><span class="line">git commit -a -s -m <span class="string">&quot;4th change&quot;</span></span><br><span class="line"></span><br><span class="line">GIT_TRACE_PACKET=1 git -c protocol.version=1 push origin  HEAD:master</span><br></pre></td></tr></table></figure>

<p>这条命令的意思是, 把本地<code>HEAD</code>指向的内容, push到远程<code>refs/heads/master</code>上.这里可以注意下, 如果你想, 你甚至可以把HEAD替换为其他任意hash值<br>输出会有一些报错, 只是因为<code>test-git1</code>不是<code>bare</code>仓库. 这不影响我们分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">20:30:46.011723 pkt-line.c:80           packet: receive-pack&gt; version 1 </span><br><span class="line">20:30:46.011807 pkt-line.c:80           packet:         push&lt; version 1 </span><br><span class="line">20:30:46.011846 pkt-line.c:80           packet: receive-pack&gt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 refs/heads/master\0report-status report-status-v2 delete-refs side-band-64k quiet atomic ofs-delta object-format=sha1 agent=git/2.35.1 </span><br><span class="line">20:30:46.011865 pkt-line.c:80           packet: receive-pack&gt; 0000 </span><br><span class="line">20:30:46.011867 pkt-line.c:80           packet:         push&lt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 refs/heads/master\0report-status report-status-v2 delete-refs side-band-64k quiet atomic ofs-delta object-format=sha1 agent=git/2.35.1 </span><br><span class="line">20:30:46.011878 pkt-line.c:80           packet:         push&lt; 0000 </span><br><span class="line">20:30:46.012115 pkt-line.c:80           packet:         push&gt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 37607550824f6769a97caa25d06a0335970abdb5 refs/heads/master\0 report-status-v2 side-band-64k object-format=sha1 agent=git/2.35.1 </span><br><span class="line">20:30:46.012125 pkt-line.c:80           packet:         push&gt; 0000 </span><br><span class="line">20:30:46.012145 pkt-line.c:80           packet: receive-pack&lt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 37607550824f6769a97caa25d06a0335970abdb5 refs/heads/master\0 report-status-v2 side-band-64k object-format=sha1 agent=git/2.35.1 </span><br><span class="line">20:30:46.012163 pkt-line.c:80           packet: receive-pack&lt; 0000 </span><br><span class="line">Enumerating objects: 5, <span class="keyword">done</span>. </span><br><span class="line">Counting objects: 100% (5/5), <span class="keyword">done</span>. </span><br><span class="line">Writing objects: 100% (3/3), 380 bytes | 380.00 KiB/s, <span class="keyword">done</span>. </span><br><span class="line">Total 3 (delta 0), reused 0 (delta 0), pack-reused 0</span><br></pre></td></tr></table></figure>

<p>当push收到了服务端<code>refs/heads/master</code>的内容之后</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push&lt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 refs/heads/master\0report-status report-status-v2 delete-refs side-band-64k quiet atomic ofs-delta object-format=sha1 agent=git/2.35.1</span><br></pre></td></tr></table></figure>

<p>然后对比自己所拥有的commit. 决定发送内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push&gt; 3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90 37607550824f6769a97caa25d06a0335970abdb5 refs/heads/master\0 report-status-v2 side-band-64k object-format=sha1 agent=git/2.35.1</span><br></pre></td></tr></table></figure>

<p>这个packet的意思是, 客户端会发送<br><code>3fb2316cbe6a7594b981c9bf8ef2fd08159a4b90</code>和<code>37607550824f6769a97caa25d06a0335970abdb5</code>之间的内容.<br>接下来和fetch如出一辙, 客户端开始计算这两笔commit之前所需要传送的object, 打包之后发送给服务器</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用:"></a>引用:</h2><ul>
<li><a target="_blank" rel="noopener" href="https://git-scm.com/book/zh/v2">ProGit</a>: Git开源社区官方维护的书籍</li>
<li><a target="_blank" rel="noopener" href="https://git-scm.com/docs/protocol-v2">Git Protocol v2</a>: git传输协议的官方文档</li>
</ul>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcdn.net/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>