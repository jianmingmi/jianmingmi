---
uuid: ae96a5c0-bf0a-11ed-aaf8-bf9757b7bfde
title: repo定制实现读写分离
date: 2023-3-21
tags:
  - Git
categories:
  - Git
---

repo定制实现读写分离

<!--more-->

## 方案一
添加全局配置``insteadOf``和``pushInsteadOf``，达到主从问题，即拉取代码从slave，推送代码到master

## 方案二（repo二开）

文件：subcmds/sync.py

### 添加参数信息

```
REGION = {
    'nj20': {
        'host': 'gerrit_nj_20',
        'user': 'pub_nj',
        'port': '29418',
        'hostname': '172.22.22.20',
        'identityFile': '~/.ssh/id_rsa',
    },
    'sz207': {
        'host': 'gerrit207',
        'port': '29418',
        'hostname': '172.22.21.207',
        'identityFile': '~/.ssh/id_rsa',
    },
}
```

### 添加传参

> __Options方法中

```
p.add_option('-r', '--region',
             dest='region', type='string', default='',
             help='from which image to synchronize the code')
```

### 解析参数

> Execute方法中

```
# region custom
global REGION
region = opt.region.lower()
config_path = os.path.join(os.environ['HOME'], '.ssh/config')
if region in REGION.keys():
    # auto config user
    if 'user' not in REGION[region]:
        user_name = self.manifest.manifestProject.UserName
        if user_name is None or user_name == '':
            print('Error: Please config user.name and user.email information!')
            sys.exit(1)
        REGION[region]['user'] = user_name

    # auto config site
    config_read = ''
    config_write = ''
    with open_f(config_path, 'r', encoding='utf8') as f:
        config_read = f.read()
        config_write = config_read
    if config_write != '' and config_write.find(REGION[region]['host']) < 0:
        config_write += '\n\n'
        config_write += 'host {}\n'.format(REGION[region]['host'])
        config_write += '    user {}\n'.format(REGION[region]['user'])
        config_write += '    port {}\n'.format(REGION[region]['port'])
        config_write += '    hostname {}\n'.format(REGION[region]['hostname'])
        config_write += '    identityFile {}\n'.format(REGION[region]['identityFile'])
        config_write += '    StrictHostKeyChecking no'
    if config_write != '' and config_read != config_write:
        with open_f(config_path, 'w', encoding='utf8') as f:
            f.write(config_write)
elif region != '':
    print('Warning: Region param is error! Please check!')
else:
    print('Warning: You are fetching code from code master! Please check!')
```

### 替换url和pushUrl

> _FetchHelper方法中

```
# region custom
region = opt.region.lower()
if region in REGION.keys():
    read_remote = REGION[region]['host']

    project.remote.pushUrl = project.remote.url
    project.remote.url = read_remote + ':' + project.name

# skip mirror sync project
if (region == 'sz207_mirr' or region == 'nj9_mirr') and (project.name in ['manifest', 'git-repo', 'repo']):
    print('Warning: mirror sync skip project: {}'.format(project.name))
    return True
```

    return True
```

