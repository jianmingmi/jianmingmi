---
uuid: 105c01e4-bcd3-11ed-abae-3fce2bc8128b
title: Linux常见问题
date: 2022-6-28
tags: [Linux]
---

Linux常见问题

<!--more-->

## 源处理
```
sudo vim /etc/apt/sources.list
sudo apt update

阿里镜像站：https://mirrors.aliyun.com/ubuntu-releases
网易镜像站：http://tel.mirrors.163.com/
中科大：http://mirrors.ustc.edu.cn/ubuntu-releases
浙大：http://mirrors.zju.edu.cn/ubuntu-releases
清华镜像站：https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases
清华帮助：https://mirrors.tuna.tsinghua.edu.cn/help
替换为阿里源：sudo sed -i 's/mirrors.aliyun.com/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list

ubuntu各版本：
    14：trusty
    16：xenial
    18：bionic
    20：focal
    22：jammy

ubuntu18
    deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic main restricted universe multiverse
    deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse
    deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse
    deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-security main restricted universe multiverse
    deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse

GPG error: The following signatures couldn't be verified because the public key is not available
    sudo gpg --keyserver keyserver.ubuntu.com --recv 5523BAEEB01FA116
    sudo gpg --export --armor 5523BAEEB01FA116 | sudo apt-key add -
    sudo apt-get update
```

## ssh
```
ssh -vT -p port user@ip（ssh登录，-v：详细信息，-T：测试，-t：开启伪终端，-tt：强制开启伪终端）
ssh-copy-id -p port user@ip（ssh免密登录）
ssh-keygen -f "/home/jmm/.ssh/known_hosts" -R [10.20.33.43]:10025（ssh更新known_hosts）
ssh -vvv（调试）

ssh免密登录
    vim ~/.ssh/authorized_keys
    chmod 600 ~/.ssh/authorized_keys
    公钥拷贝到里面

指定秘钥：
    vim ~/.ssh/config
    chmod 600 ~/.ssh/config
        Host man1
            HostName 192.168.2.18
            IdentityFile ~/.ssh/id_rsa
            User root
            Port 22

使ssh生效：
    eval "$(ssh-agent -s)"
    ssh-add
    ssh-agent bash

Their offer:diffie-hellman-group1-sha1问题：
    vim ~/.ssh/config
    Host *
        StrictHostKeyChecking no
        KexAlgorithms +diffie-hellman-group1-sha1

启用ssh-rsa：
    vim ~/.ssh/config
    Host *
        HostKeyAlgorithms +ssh-rsa
        PubkeyAcceptedKeyTypes +ssh-rsa

修改22端口：
    sudo vim /etc/ssh/sshd_config
        修改Port 22为65534以下即可
    sudo /etc/init.d/ssh restart #重启ssh

允许远程登录：
    sudo vim /etc/ssh/sshd_config
        PermitRootLogin yes
    sudo service ssh restart
```

## crontab定时任务
```
crontab -e：添加任务
crontab -l：查看任务列表

0 2 * * * /bin/bash backup.sh：每天 02:00 执行任务
0 5,17 * * * /bin/bash /scripts/script.sh：每天 5:00和17:00执行任务
*/60 * * * * /bin/bash /scripts/script.sh：每隔一个小时执行一次
0 */2 * * * /bin/bash /scripts/script.sh：每隔两个小时执行一次
0 17 * * sun /bin/bash /scripts/script.sh：每周日 17:00 执行任务
```

## 开机启动
```
1.修改启动文件（ubuntu14、ubuntu16支持）
    /etc/rc.local
2.配置启动脚本
    sudo vim /etc/init.d/automount
        #!/bin/sh

        ### BEGIN INIT INFO
        # Provides:          jmm.com
        # Required-Start:    $local_fs $remote_fs $network $syslog $named
        # Required-Stop:     $local_fs $remote_fs $network $syslog $named
        # Default-Start:     2 3 4 5
        # Default-Stop:      0 1 6
        # Short-Description: jmm service
        # Description:       jmm service
        ### END INIT INFO

        busybox mount -t nfs -o nolock 10.169.0.203:/data/backup /data/mirror
        exit 0

    sudo chmod +x /etc/init.d/automount
    sudo update-rc.d automount defaults 99（开启）
    sudo update-rc.d -f automount remove（移除）
```

## service 和 systemctl
```
service命令其实是去/etc/init.d目录下，去执行相关程序
    sudo service redis start
    sudo /etc/init.d/redis start
systemd作用是提高系统的启动速度，尽可能启动较少的进程，尽可能更多进程并发启动，systemd对应的进程管理命令是systemctl。
    兼容service：
    sudo systemctl redis start（启动服务）
    systemctl enable redis（开机启动服务）
```

## 防火墙

```
iptables/firewall/ufw
    iptables比较老默认开放就行
    ufw是debian系列的（iptables托管给ufw）
    firewall是redhat系列的

ufw接管防火墙
    sudo ufw enable（开启，阶段iptables，底层还是iptables）
    sudo ufw disable（关闭）
    sudo ufw status（查看防火墙表）
    sudo ufw status verbose（查看策略）
    sudo ufw status numbered（查看防火墙表 加行号，删除 sudo ufw delete 1）

    sudo ufw allow 80（允许80，sudo ufw delete allow 80（删除就是在规则前加delete））
    sudo ufw deny 80（拒绝80）

    sudo ufw allow 80/tcp（允许80，tcp形式）
    sudo ufw allow 9000:9002（允许一段端口）
    sudo ufw allow from 192.168.29.36（允许ip）
    sudo ufw allow from 192.168.1.0/24（允许ip段）
    sudo ufw allow from 192.168.29.36 to any port 80（允许ip访问80）
    sudo ufw allow from 192.168.29.36 to any port 80 proto tcp（允许ip以tcp形式访问80）

iptables防火墙
    sudo iptables --line-number -nL（查看列表）
    sudo iptables -F（清空列表）
    sudo iptables -D INPUT 3（删除input表第三条规则）

    sudo iptables -P INPUT ACCEPT（允许input表）
    sudo iptables -P OUTPUT ACCEPT（允许output表）
    sudo iptables -P INPUT DROP（禁止input表）
    sudo iptables -P OUTPUT DROP（禁止output表）

    sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT（允许某个端口进）
    sudo iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT（允许某个端口出）
    sudo iptables -A INPUT -s 192.168.0.3 -j ACCEPT（允许某个ip进）
    sudo iptables -A OUTPUT -s 192.168.0.3 -j ACCEPT（允许某个ip出）
    sudo iptables -A INPUT -s 192.168.0.0/24 -j ACCEPT（允许192.168.0.1 - 192.168.0.254网段访问）

    sudo iptables -A INPUT -p tcp --dport 22 -j DROP（禁止某个端口进）
    sudo iptables -A OUTPUT -p tcp --sport 22 -j DROP（禁止某个端口出）
    sudo iptables -A INPUT -s 192.168.0.3 -j DROP（禁止某个ip进）
    sudo iptables -A OUTPUT -s 192.168.0.3 -j DROP（禁止某个ip出）

    sudo iptables -I INPUT 1 -s 192.168.0.3 -j ACCEPT（允许某个ip进，插入）
```

## vim编辑器
```
编辑文件：vim [file]
三种模式：命令模式（esc进入）、底线命令模式（:/?进入）、编辑模式（i、a、o、r、I、A、O、R进入）、块模式（ctrl+v进入）
命令模式（前面加数字可以达到重复的效果）
    删除行：dd
    复制行：yy
    拷贝行：p
    首行：gg
    尾行：G
    删除数字：x（X为向前删除）
    撤销：u（ctrl+r反撤销）
    重复上一次命令：.
    显示当前文件名和位置：ctrl+g
    合并两行：J

底线命令模式
    退出：:wq!、:q!、:x!、:qa!
    跳转到行：:20
    查找：/xxx （忽略大小写:\c，n下一个，N上一个）
    反向查找：?xxx（忽略转义和大小写）
    替换每行所有：:%s/aaa/bbb/g（替换当前行第一个：:s/aaa/bbb/，用其他分割符：%s#aaa#bbb#g）
    列出所有匹配项：:g/aaa（忽略大小写:\c）
    显示行号：set number（关闭行号：set nonumber，可写在~/.vimrc里面）
    取消自动换行：set nowrap（换行：set wrap）
    搜索关键字高亮：set incsearch（关闭高亮：set noincsearch）
    忽略大小写：set ignorecase（关闭忽略大小写：set noignorecase）
    取消粘贴缩进：set paste
    取消鼠标选择：set mouse=（开启鼠标选择：set mouse=a）

其他
    vim分屏：:vs [file]（左右分屏），ctrl + w w（切换屏幕）
    vimdiff对比文件：vimdiff file1 file2（dp：应用于另一边，do：获得另一边的修改，zo：展开）
    meld对比文件：meld file1 file2
```

## 配置静态ip
```
network（ubuntu16及以下）
    sudo vim /etc/network/interfaces
        auto enp3s0
        iface enp3s0 inet static
        address 192.168.0.200
        netmask 255.255.255.0
        gateway 192.168.0.1
        dns-nameserver 8.8.8.8

    sudo service networking restart

netplan（ubuntu18及以上）
    sudo vim /etc/netplan/01-network-manager-all.yaml
        network:
          version: 2
          renderer: NetworkManager
          ethernets:
             eno1: # 网卡
               dhcp4: no # dhcp4关闭
               addresses: [192.168.202.36/24] # ip和掩码
               gateway4: 192.168.202.1 # 网关
               nameservers:
                 addresses: [8.8.8.8,114.114.114.114] #设置DNS

    sudo netplan apply

netplan（ubuntu20及以上）
    sudo vim /etc/netplan/01-network-manager-all.yaml
        network:
          version: 2
          renderer: NetworkManager
          ethernets:
             eno1:
               dhcp4: no
               addresses: [10.170.0.238/23]
               routes:
               - to: default
                 via: 10.170.0.1
               nameservers:
                 addresses: [8.8.8.8,114.114.114.114] #设置DNS

    sudo netplan apply
```

## dependency problems - leaving unconfigured问题
```
sudo mv /var/lib/dpkg/info/ /var/lib/dpkg/info_old/
sudo mkdir /var/lib/dpkg/info/
sudo apt-get update
sudo apt-get -f install
sudo apt-get upgrade
```

## profile和bashrc
```
profile：系统全局环境登录的一些配置
bashrc：用户bash的一些配置
.env：进入目录时初始化环境
执⾏顺序为：/etc/profile -> (~/.bash_profile | ~/.bash_login | ~/.profile) -> ~/.bashrc -> /etc/bashrc -> ~/.
```

## 文本处理三剑客（grep/egrep、sed、awk）

```
正则支持（三剑客都是以行为单位进行处理）
    grep：默认不支持扩展正则，加上-E支持扩展正则，如果不加上-E，使用\{\}要加上\进行转义。
    egrep：支持基础和扩展正则，相当于grep -E。
    sed：默认不支持扩展正则，机上-r选项支持扩展正则，如果不加上-r，使用\{\}要加上\进行转义。
    awk：默认支持所有正则。

    shell的正则分为两类：
        基础正则表达式、扩展正则表达式 {扩展的有+、？、|、（）}
    区分正则和通配符：
        1、只要涉及grep/egrep sed awk都是正则。其他的都是统配符
        2、涉及文件和目录名——统配符；涉及文本内容——正则
    基础正则
        ^ ：表示匹配字符串开头
        . ：匹配一个字符，且该字符必须存在
        * ：匹配前面一个字符的0个或者多个
        .* ：可以匹配任意长度的任意内容
        $ ：匹配字符串结尾
        [] ：表示匹配括号里的任意一个字符
        ^[^s] ：^在中括号中有^表示取反，非。匹配不以s开头的字符
        \{n,m\} ：匹配字符n到m次，至少n次，至多m次
        \(\) ：分组
        \<\> ：单词锚定，\<root\<，root必须作为一行的单词出现,也可\broot\b
    拓展正则
        grep -E ：-E支持拓展正则，或者直接使用egrep，拓展正则支持所有的基础正则
        ? ：最多匹配一个，可以是0个
        + ：至少匹配一个可以是多个
        | ：或
        () ：分组

grep使用
    -r：目录递归
    -n：打印行号
    -s：不显示错误
    -i：忽略大小写
    -o：只打印匹配的内容
    -v：取反，打印不匹配的行
    -q：如果有匹配的内容则返回状态值0
    -c：匹配的内容有多少行
    -E：扩展正则表达式
    -P：支持perl的正则语法
    -A1：after打印匹配的后几行
    -B1：before打印匹配的后几行
    -C1：打印匹配的前后几行

sed操作
    选项
        -i：直接修改写入到文件内容，而不是输出到终端。如果不使用-i那么只会修改内存中的内容，而不会写入到磁盘。
        -n：输出模式，取消默认的sed软件输出，常与sed-commands的p连用
        -e：多点操作，一条命令语句执行多个sed操作。
        -r：使用扩展正则表达式
    sed-commands（$表示行末）：
        i ：insert 插入，在指定的行前添加一行或多行文本
        a ：append 在指定行后面追加一行或者多行文本
        s ：search 搜索字符串
        c ：change 取代指定的行或者多行
        d ：delete 删除指定的行或者多行
        p ：print 打印模式空间的内容，通常p和-n选项一起使用
        ! ：取非，对指定行以外的所有行应用命令
    例子
        第一行前添加：sed "1 i hello world" xxx.xml
        第一行后添加：sed "1 a hello world" xxx.xml
        最后一行之后添加：sed "$ a hello world" xxx.xml
        删除第一行：sed "1 d" xxx.xml
        删除1-最后行：sed "1,$ d" xxx.xml
        取代第一行：sed "1 c hello world\nname" xxx.xml
        取代1-最后行：sed "1,$ c hello world\nname" xxx.xml
        打印第一行：sed -n "1 p" xxx.xml
        打印1-最后行：sed -n "1,$ p" xxx.xml
        打印除2-5行：sed -n '2,5! p' xxx.xml

        找到某行在前添加：sed "/path=\"build\/make\"/i hello world" xxx.xml
        找到某行在后添加：sed "/path=\"build\/make\"/a hello world" xxx.xml
        找到某行后删除：sed "/path=\"build\/make\"/d" xxx.xml
        找到某行后取代：sed "/path=\"build\/make\"/c hello world" xxx.xml
        找到某行后打印：sed -n "/path=\"build\/make\"/p" xxx.xml

        多点操作：sed -e '1d' -e '5,7d' xxx.xml

        替换文件内容：sed "s/path=\"build\/make\"/path=\"hello world\"/g" xxx.xml
        替换文件内容（基础正则，使用取反来达到懒汉模式）：sed "s/path=\"[^\"]*\"/path=\"hello world\"/g" xxx.xml

awk操作
    $0，整条记录
    $1、$2、$3，输出一个指定的字段
    FS，段分隔符，默认空格
    RS，行分隔符
    NR，行号
    NF，字段数量，$NF，最后一个字段
    ~，表示正则匹配
    //，进行内容匹配

    输出所有行：awk '{print $0}' /etc/passwd
    输出第二行：awk 'NR==2{print $0}' /etc/passwd
    输出二到五行：awk 'NR>=2&&NR<=5{print $0}' /etc/passwd
    输出行号：awk '{print NR,$0}' /etc/passwd
    输出行号：awk '{print NR" "$0}' /etc/passwd
    分隔符：awk -F ':' '{print $1,$2,$3,$4}' /etc/passwd
    锚定查找并输出：awk '/\<root\>/{print NR"\t"$0}' /etc/passwd
    正则匹配：awk '$0~/root/' /etc/passwd
    末尾查找字串：awk -F ':' '$NF~/sbin/{print $0}' /etc/passwd
    多个分隔符：awk -F '[:/]+' '{print $5,$6,$7,$8}' /etc/passwd

    开始前输入：awk -F : 'BEGIN{print "USERNAME"} {print $1}' /etc/passwd
    前后输入：awk -F : 'BEGIN{print "USERNAME"} {print $1} END{print "END OF FILE"}' /etc/passwd
    统计次数：awk 'BEGIN{num=0}/nologin/{num++}END{print num}' /etc/passwd
    遍历：awk -F : '{ken[$NF]++}END{for (i in ken) print ken[i] i}' /etc/passwd


    cat access.log | awk '{print $1}' | sort | uniq -c | sort -rn | head -3
    awk '{ken[$1]++}END{for (i in ken) print ken[i],i}' access.log | sort -rn | head -3
```