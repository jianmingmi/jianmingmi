---
title: OTA升级
date: 2022-7-1
tags: [ota]
---

OTA升级

<!--more-->

## otapackage（**会生成target包和ota完整包**）
```bash
name := $(TARGET_PRODUCT)
ifeq ($(TARGET_BUILD_TYPE),debug)
  name := $(name)_debug
endif
name := $(name)-ota-$(FILE_NAME_TAG)

INTERNAL_OTA_PACKAGE_TARGET := $(PRODUCT_OUT)/$(name).zip
INTERNAL_OTA_METADATA := $(PRODUCT_OUT)/ota_metadata

$(INTERNAL_OTA_PACKAGE_TARGET): KEY_CERT_PAIR := $(DEFAULT_KEY_CERT_PAIR)
$(INTERNAL_OTA_PACKAGE_TARGET): .KATI_IMPLICIT_OUTPUTS := $(INTERNAL_OTA_METADATA)
$(INTERNAL_OTA_PACKAGE_TARGET): $(BUILT_TARGET_FILES_PACKAGE) $(OTA_FROM_TARGET_FILES)
  @echo "Package OTA: $@"
  $(call build-ota-package-target,$@,-k $(KEY_CERT_PAIR) --output_metadata_path $(INTERNAL_OTA_METADATA))

.PHONY: otapackage
otapackage: $(INTERNAL_OTA_PACKAGE_TARGET)
```

## target-files-package（**会生成target**）
```bash
name := $(TARGET_PRODUCT)
ifeq ($(TARGET_BUILD_TYPE),debug)
  name := $(name)_debug
endif
name := $(name)-target_files-$(FILE_NAME_TAG)

intermediates := $(call intermediates-dir-for,PACKAGING,target_files)
BUILT_TARGET_FILES_PACKAGE := $(intermediates)/$(name).zip
$(BUILT_TARGET_FILES_PACKAGE): intermediates := $(intermediates)
$(BUILT_TARGET_FILES_PACKAGE): \
      zip_root := $(intermediates)/$(name)

.PHONY: target-files-package
target-files-package: $(BUILT_TARGET_FILES_PACKAGE)
```

## 做差分包所需文件（**系统**）
```bash
├── bin
├── build
│     └── make
│         └── target
│             └── product
│                 └── security
├── device
│     ├── google
│     │     ├── cuttlefish
│     │     │     └── host
│     │     │         └── frontend
│     │     └── vrservices
│     │         └── vrcore
│     │             └── sepolicy
│     └── qcom
│         └── sepolicy_vndr
│             ├── legacy
│             │     └── vendor
│             └── qva
│                 └── vendor
├── external
│     └── avb
│         └── test
│             └── data
├── framework
│     ├── apksigner.jar
│     ├── boot_signer.jar
│     ├── signapk.jar
│     └── verity_signer.jar
├── lib64
├── releasetools
└── vendor
    ├── huaqin
    │     └── factory
    │         └── BaseFactoryKit
    │             └── keystore
    ├── partner_modules
    │     └── NetworkStackPrebuilt
    │         ├── localtest
    │         │     └── networkstack.x509.pem
    │         └── networkstack.x509.pem
    └── qcom
        └── proprietary
            └── prebuilt_HY11
                └── target
```

## 做差分包所需文件（**总结**）
```bash
cp -r build/target/product/security $target
cp -r build/make/tools/releasetools $target
cp -r out/host/linux-x86 $target
```

## 根据target包生成ota差分包
```bash
build/make/tools/resleasetools/ota_from_target_files -k key_path -i old new output
    -k/--package_key build/make/target/product/security/testkey：key cert路径
    -i old.zip new.zip update.zip：差分包参数
    -p/--path out/host/linux-x86：host out路径
    -s/--device_specific ./device/qcom/common：指定了device-specific extension路径
    -v/--verify：校验和，仅非A/B设备
    --block：为非A/B设备生成基于块
    --skip_compatibility_check：跳过包的兼容性检查
    --override_timestamp：覆盖时间戳
    --downgrade：允许降级
```