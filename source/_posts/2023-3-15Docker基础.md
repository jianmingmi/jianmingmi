---
uuid: d934bd60-bd7c-11ed-ad3f-df41b5cfa754
title: Docker基础
date: 2023-3-15
tags: [Docker]
---

Docker基础

<!--more-->

## docker 安装和启动
```
dibian（docker.io是debian团队维护）
    sudo apt install docker.io -y
    sudo usermod -aG docker [user]
    sudo service docker restart
snap安装
    sudo snap install docker
    sudo snap start docker
    注：通过snap安装的docker配置文件在：/var/snap/docker/471/config/daemon.json
docker-ce（doker-ce是docker团队维护）
    sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common
    curl -k -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
    sudo add-apt-repository "deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"
    sudo apt update
    sudo apt install docker-ce -y
    sudo usermod -aG docker [user]
    sudo service docker restart
```

## docker 命令：
```
docker info（查看docker目录，镜像站等）
docker search [img]	搜索镜像
docker images	列出镜像
docker rmi [img]	删除镜像
docker pull ubuntu:14.04	拉取14.04镜像

docker stats 列出容器状态
docker ps -a    列出所有容器
docker stop my_sshd_ubuntu    停止容器
docker rm my_sshd_ubuntu    删除容器
docker start my_sshd_ubuntu    启动容器
docker restart my_sshd_ubuntu    停止容器
docker inspect my_sshd_ubuntu	查看容器信息

docker run -d --restart always --name my_sshd_ubuntu ubuntu:14.04	运行容器(-d后台运行)
docker cp my_docker_jenkins:/etc/localtime .	复制文件
docker exec -it my_sshd_ubuntu bash    进入容器（exec运行命令，-it交互式运行）
docker logs my_sshd_ubuntu  查看容器log
docker save -o ubuntu_14.04.tgz ubuntu:14.04（镜像打包）
docker load -i ubuntu_14.04.tgz（镜像导入）
docker info（列出docker信息）

docker network prune（清理不用的自定义网络）
```

## 镜像、目录、提交及操作
```
docker hub
    https://hub.docker.com/r/library    jianmingmi

提交镜像
    docker login -u jianmingmi [192.168.33.86:8888]
    docker commit my_mm_wiki jianmingmi/mm-wiki:0.2.1
    docker tag jianmingmi/mm-wiki:0.2.1 jianmingmi/mm-wiki:latest
    docker push jianmingmi/mm-wiki:0.2.1
    docker push jianmingmi/mm-wiki:latest

更新镜像源
    sudo vim /etc/docker/daemon.json
        {
        "registry-mirrors": ["http://docker.mirrors.ustc.edu.cn"]
        }
    sudo systemctl daemon-reload; sudo systemctl restart docker

修改docker root dir位置
    sudo vim /etc/docker/daemon.json
        {
            "graph": "/data/docker"
        }
    sudo systemctl daemon-reload; sudo systemctl restart docker

修改docker ip段位置
    sudo vim /etc/docker/daemon.json
    {
        "default-address-pools": [
          {
            "base": "172.100.0.0/16",
            "size": 24
          }
        ]
    }
    sudo systemctl daemon-reload; sudo systemctl restart docker

注：
    container_name网络互通的情况下，可以当做ip
    networks可以网络互通
    depends_on用于启动时候，网络互通，并形成依赖关系
    links用于启动后，网络互通
```

## 制作docker ubuntu镜像
```
vim Dockerfile
    FROM ubuntu:16.04
    MAINTAINER jmm

    # 更新源、安装软件、创建
    RUN apt-get update -y && apt-get install -y openssh-server sudo && mkdir -p /var/run/sshd && echo "LANG=C.UTF-8" >> /etc/profile

    # 设置环境
    RUN echo "#!/bin/bash" > /start.sh && echo "/usr/sbin/sshd -D" >> /start.sh && chmod 755 /start.sh

    # 创建用户
    RUN useradd ubuntu -m -s /bin/bash && echo 'ubuntu:1qaz!QAZ' | chpasswd && usermod -aG sudo ubuntu

    # 如果有多个RUN，自上而下依次运行，每次运行都会形成新的层，建议&& 放入一行运行
    # 如果有多个CMD，只有最后一个运行
    # 如果有多个Entrypoint，只有最后一个运行
    # 如果CMD和entrypoint共存，只有entrypoint运行，且最后的CMD会当做entrypoint的参数
    ENTRYPOINT ["/start.sh"]

编译
    docker build -t jianmingmi/ubuntu:16.04 .

docker-compose启动
    vim docker-compose.yml
    version: "3"
    services:
      my_ubuntu_18:
        container_name: my_ubuntu_18
        image: jianmingmi/ubuntu:18.04
        restart: always
        ports:
          - "10020:22"
        volumes:
          - ./work:/work
          - /etc/localtime:/etc/localtime:ro

启动
    docker run -d --restart always \
        --name my_ubuntu_18 \
        -p 10020:22 \
        -v /work/docker/my_ubuntu_18/work:/work \
        -v /etc/localtime:/etc/localtime \
        jianmingmi/ubuntu:18.04
```

## 制作docker编译镜像
```
1.依赖jianmingmi/ubuntu镜像启动
    vim docker-compose.yml
    version: "3"
    services:
      my_ubuntu_18:
        container_name: my_ubuntu_18
        image: jianmingmi/ubuntu:18.04
        restart: always
2.修改/start.sh脚本
    #!/bin/bash
    if [ x"${USER_NAME}" != x"" -a x"${USER_PWD}" != x"" ];then
      cur_user=$(cat /etc/passwd | grep ${USER_NAME})
      if [ x"${cur_user}" == x"" ];then
        useradd ${USER_NAME} -s /bin/bash -d /home/${USER_NAME} && echo "${USER_NAME}:${USER_PWD}" | chpasswd && usermod -aG sudo ${USER_NAME}
        cp /home/ubuntu/.bashrc /home/ubuntu/.profile /home/${USER_NAME}
        chmod 777 /home/${USER_NAME}/.bashrc
        chmod 777 /home/${USER_NAME}/.profile
      fi
    fi
    /usr/sbin/sshd -D
3.替换源、安装软件、repo、libfile-copy-recursive-perl、rsync、python2（sudo apt install python-minimal）等
4.镜像提交推送
    docker login 192.168.33.86:8888
    docker commit my_ubuntu_18 192.168.33.86:8888/library/ubuntu_tinno:18.04
    docker push 192.168.33.86:8888/library/ubuntu_tinno:18.04
5.配置registry-mirrors
    sudo vim /etc/docker/daemon.json
        {
        "registry-mirrors": ["http://192.168.33.86:8888"]
        }
    sudo systemctl daemon-reload; sudo systemctl restart docker
6.编写 docker-compose.yml
    vim docker-compose.yml
    version: "3"
    services:
      mijianming:
        container_name: mijianming
        image: 192.168.33.86:8888/library/ubuntu_tinno:18.04
        restart: always
        ports:
          - "10021:22"
        volumes:
          - ./mijianming:/home/mijianming
          - /etc/localtime:/etc/localtime:ro
        environment:
          - USER_NAME=mijianming
          - USER_PWD=mijianming
```

## docker 集群搭建
```
vim docker-compose.yml
version: "3"
services:
  my_ubuntu_18_1:
    container_name: my_ubuntu_18_1
    image: jianmingmi/ubuntu:18.04
    restart: always
    ports:
      - "10031:22"
    volumes:
      - ./work:/work
      - /etc/localtime:/etc/localtime:ro
    networks:
      jiqun:

  my_ubuntu_18_2:
    container_name: my_ubuntu_18_2
    image: jianmingmi/ubuntu:18.04
    restart: always
    ports:
      - "10032:22"
    volumes:
      - ./work:/work
      - /etc/localtime:/etc/localtime:ro
    networks:
      jiqun:

networks:
  jiqun:
```

## docker 限制资源使用
```
deploy:
  resources:
     limits:
        cpus: "2.00"
        memory: 5G
     reservations:
        memory: 200M
```

## 制作镜像私库
```
启动
    docker run -d --restart always -p 5000:5000 -v /home/android/service/registry/registry:/var/lib/registry --name private_registry registry

修改配置
    sudo vim /etc/docker/daemon.json
        {
        "insecure-registries":["192.168.33.60:5000"]
        }

制作镜像并推送
    docker pull hello-world
    docker tag hello-world:latest 192.168.33.60:5000/hello-world
    docker push 192.168.33.60:5000/hello-world
    docker pull 192.168.33.60:5000/hello-world

查看镜像
    http://192.168.33.60:5000/v2/_catalog
```

## docker-compose：
```
docker-compose下载（已同步到gitee）：
    curl -L "https://gitee.com/jianmingmi/compose/releases/download/v1.29.2/docker-compose-Linux-x86_64" -o docker-compose
    curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-Linux-x86_64" -o docker-compose
docker-compose up -d：启动容器
docker-compose restart：重启容器
docker-compose down：移除容器
```

## docker-machine（搭建docker环境）：
```
下载：sudo curl -L https://github.com/docker/machine/releases/download/v0.16.2/docker-machine-`uname -s`-`uname -m` >/usr/local/bin/docker-machine && sudo chmod +x /usr/local/bin/docker-machine
创建：docker-machine create -d generic --generic-ip-address=10.20.33.43 --generic-ssh-port=2222 --generic-ssh-key ~/.ssh/id_rsa --generic-ssh-user=jmm 10.20.33.43
docker-machine ls（列出机器）
docker-machine active（列出活动的机器）
docker-machine inspect 10.20.33.43（列出详细）
docker-machine ip 10.20.33.43（列出ip）
docker-machine stop 10.20.33.43（停止）
docker-machine rm 10.20.33.43（删除）
docker-machine ssh 10.20.33.43（进入机器）

参数
    privileged: true（设置容器的权限为root）
```

## docker swarm（集群）：
```
docker swarm init --advertise-addr 10.20.33.34
docker swarm join --token [token] 10.20.33.34:2377
docker network create -d overlay nginx_net
docker network ls
docker service create --replicas 1 --network nginx_net --name my_nginx -p 80:80 nginx
docker service ls
docker service inspect --pretty my_nginx
docker service ps my_nginx
docker service rm my_nginx

docker swarm leave -f（离开集群）
docker node ls
docker node update --availability drain 10.20.33.43（修改节点状态，drain 下线，active 上线）
```

## 群辉docker配置文件
```
/var/packages/Docker/etc/dockerd.json
```

## docker可视化面板
```
vim docker-compose.yml
    version: "3"
    services:
        my_portainer:
            container_name: my_portainer
            image: portainer/portainer
            restart: always
            ports:
                - "9000:9000"
            command:
                -H unix:///var/run/docker.sock
            volumes:
                - /var/run/docker.sock:/var/run/docker.sock
                - ./data:/data
```

## Harbor
```
企业级 Registry 服务器
https://github.com/jianmingmi/harbor
安装
    wget https://github.com/goharbor/harbor/releases/download/v2.6.3/harbor-offline-installer-v2.6.3.tgz
    tar -zxvf harbor-offline-installer-v2.6.3.tgz
    cp harbor.yml.tmpl harbor.yml
    vim harbor.yml
        修改hostname、port、harbor_admin_password
        注释掉https
    ./install.sh
```

## Kubernetes教程（k8s）
```
k8s是一个开源的容器集群管理系统，可以实现容器集群的自动化部署、自动扩缩容、维护等功能。
    1、故障迁移：当某一个node节点关机或挂掉后，node节点上的服务会自动转移到另一个node节点上，这个过程所有服务不中断。这是docker或普通云主机是不能做到的
    2、资源调度：当node节点上的cpu、内存不够用的时候，可以扩充node节点，新建的pod就会被kube-schedule调度到新扩充的node节点上
    3、资源隔离：创建开发、运维、测试三个命名空间，切换上下文后，开发人员就只能看到开发命名空间的所有pod，看不到运维命名空间的pod，这样就不会造成影响，互不干扰
         传统的主机或只有docker环境中，登录进去就会看到所有的服务或者容器
    4、因为采用docker容器，进程之间互不影响，
    5、安全：不同角色有不同的权限，查看pod、删除pod等操作；RBAC认证增加了k8s的安全
        快速精准地部署应用程序
            限制硬件用量仅为所需资源
    Kubernetes 的优势
        可移动: 公有云、私有云、混合云、多态云
        可扩展: 模块化、插件化、可挂载、可组合
        自修复: 自动部署、自动重启、自动复制、自动伸缩

    负载均衡
        k8s可以更快的更新新版本，打包应用，更新的时候可以做到不用中断服务，服务器故障不用停机，从开发环境到测试环境到生产环境的迁移极其方便，一个配置文件搞定，一次生成image，到处运行。。。

1.关闭交换分区和防火墙和selinux
    sudo vim /etc/fstab
    systemctl stop ufw && systemctl disable ufw
2.安装docker
    sudo apt install docker.io -y
    sudo usermod -aG docker [user]
    sudo service docker restart
3.安装k8s
    echo "deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main" > /etc/apt/sources.list.d/kubernetes.list
    apt update
    sudo gpg --keyserver keyserver.ubuntu.com --recv FEEA9169307EA071
    sudo gpg --export --armor FEEA9169307EA071 | sudo apt-key add -
    sudo apt-get update
    sudo apt-get install -y kubelet=1.16.3-00 kubectl=1.16.3-00 kubeadm=1.16.3-00
4.初始化
    kubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version=v1.16.3 --pod-network-cidr=10.0.0.0/24
    client加入命令需要复制
5.初始化环境变量
    mkdir -p $HOME/.kube
    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    sudo chown $(id -u):$(id -g) $HOME/.kube/config
6.client部分
    需要1、2、3部分
    需要第四步的加入命令
7.安装网络插件Flannel
    https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
    注：如果遇到The connection to the server raw.githubusercontent.com was refused - did you specify the right host or port?
        查询真实ip：https://www.ipaddress.com，写到/etc/hosts中
注：参考地址
    https://zhuanlan.zhihu.com/p/97605697
    https://www.cnblogs.com/fisherbook/p/14277388.html
    https://blog.csdn.net/qq_43657581/article/details/97494505

基本使用：
    kubectl get nodes（查看所有的节点的状态）
    kubectl get pod -n kube-system（查看所有节点上的组件容器）
    kubectl get pod -n kube-system -o wide（查看更多信息）
    kubectl describe pod kube-controller-manager-master -n kube-system（查看某个pod具体信息）
    kubectl logs -f -n kube-system kube-controller-manager-master（查看某个pod日志）

    kubectl create -f kubia-manual.yaml（创建一个pod）
        apiVersion: v1
        kind: Pod
        metadata:
          name: kubia-manual
        spec:
          containers:
          - image: luksa/kubia
            name: kubia
            ports:
            - containerPort: 8080
              protocol: TCP
    kubectl create namespace hello-world（创建命名空间）
    kubectl explain pod（查看pod详细解释）
    kubectl explain pod.matedata
    kubectl delete pod kubia-4n2tg（删除pod）
    kubectl get pod kubia-manual -o yaml（查看某个pod配置）
    kubectl edit pod kubia-manual（编辑某个pod配置）Swarm
```