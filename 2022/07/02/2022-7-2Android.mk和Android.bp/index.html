<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="&lt;p&gt;Android.mk和Android.bp&lt;/p&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Android.mk和Android.bp | Mijm Blog</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 6.3.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Android/" rel="tag">Android</a></div><div class="post-time">2022-07-02</div></div></div><div class="container post-header"><h1>Android.mk和Android.bp</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Android-bp%E5%92%8CAndroid-mk"><span class="toc-number">1.</span> <span class="toc-text">Android.bp和Android.mk</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">格式转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.</span> <span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">调用流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android-mk%E5%B8%B8%E7%94%A8%E5%8F%98%E9%87%8F"><span class="toc-number">2.</span> <span class="toc-text">Android.mk常用变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inherit-product%E5%92%8Cinclude%E5%8C%BA%E5%88%AB"><span class="toc-number">3.</span> <span class="toc-text">inherit-product和include区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#include-call-all-subdir-makefiles-%E5%92%8Cinclude-call-all-makefiles-under-LOCAL-PATH-%E5%8C%BA%E5%88%AB"><span class="toc-number">4.</span> <span class="toc-text">include $(call all-subdir-makefiles)和include $(call all-makefiles-under,$(LOCAL_PATH))区别</span></a></li></ol></details></div><div class="container post-content"><p>Android.mk和Android.bp</p>
<span id="more"></span>

<h2 id="Android-bp和Android-mk"><a href="#Android-bp和Android-mk" class="headerlink" title="Android.bp和Android.mk"></a>Android.bp和Android.mk</h2><h3 id="格式转换"><a href="#格式转换" class="headerlink" title="格式转换"></a>格式转换</h3><p>通过<code>Kati</code>将<code>Android.mk</code>转换成<code>ninja</code>格式的文件<br>通过<code>Blueprint + Soong</code>将<code>Android.bp</code>转换成<code>ninja</code>格式的文件<br>通过<code>androidmk</code>将将<code>Android.mk</code>转换成<code>Android.bp</code>，但针对没有分支、循环等流程控制的<code>Android.mk</code>才有效</p>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><ol>
<li><code>ninja</code>是一个编译框架，会根据相应的<code>ninja</code>格式的配置文件进行编译，但是<code>ninja</code>文件一般不会手动修改，而是通过将 <code>Android.bp</code>文件转换成<code>ninja</code>格文件来编译</li>
<li><code>Android.bp</code>是纯粹的配置，没有分支、循环等流程控制，不能做算数逻辑运算。如果需要控制逻辑，那么只能通过<code>Go</code>语言编写</li>
<li><code>Soong</code>类似于之前的<code>Makefile</code>编译系统的核心，负责提供<code>Android.bp</code>语义解析，并将之转换成<code>Ninja</code>文件。<code>Soong</code>还会编译生成一个<code>androidmk</code>命令，用于将<code>Android.mk</code>文件转换为<code>Android.bp</code>文件</li>
<li><code>Blueprint</code>是生成、解析<code>Android.bp</code>的工具，是<code>Soong</code>的一部分。<code>Soong</code>负责<code>Android</code>编译而设计的工具，而<code>Blueprint</code>只是解析文件格式，<code>Soong</code>解析内容的具体含义。<code>Blueprint</code>和<code>Soong</code>都是由<code>Golang</code>写的项目，从<code>Android 7.0</code>，<code>prebuilts/go/</code>目录下新增<code>Golang</code>所需的运行环境，在编译时使用</li>
<li><code>kati</code>是专为<code>Android</code>开发的一个基于<code>Golang</code>和<code>C++</code>的工具，主要功能是把<code>Android</code>中的<code>Android.mk</code>文件转换成Ninja文件。代码路径是<code>build/kati/</code>，编译后的产物是<code>ckati</code></li>
</ol>
<blockquote>
<p>Android.mk -&gt; Android.bp<br>Android.mk 转换为 <code>Android.bp,Google</code>提供了官方工具<code>androidmk</code>，只针对简单的mk文件转换，涉及分支，循环等控制转换并不准确<br>androidmk使用 ：<code>androidmk android.mk &gt; android.bp</code></p>
</blockquote>
<h3 id="调用流程"><a href="#调用流程" class="headerlink" title="调用流程"></a>调用流程</h3><p><code>Makefile-&gt; build/core/main.mk -&gt; build/core/config.mk -&gt; build/core/envsetup.mk -&gt; build/core/product_config.mk</code></p>
<h2 id="Android-mk常用变量"><a href="#Android-mk常用变量" class="headerlink" title="Android.mk常用变量"></a>Android.mk常用变量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PRODUCT_OUT</span><br><span class="line">TARGET_OUT_VENDOR</span><br><span class="line">TARGET_COPY_OUT_VENDOR</span><br><span class="line">TARGET_COPY_OUT_PRODUCT</span><br><span class="line">TARGET_COPY_OUT_SYSTEM_EXT</span><br></pre></td></tr></table></figure>


<h2 id="inherit-product和include区别"><a href="#inherit-product和include区别" class="headerlink" title="inherit-product和include区别"></a>inherit-product和include区别</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">include device/mediatek/mt2712/device.mk</span><br><span class="line">$(call inherit-product, device/mediatek/mt2712/device.mk)</span><br><span class="line">$(call inherit-product-if-exists, device/mediatek/mt2712/device.mk)</span><br><span class="line"></span><br><span class="line">从注释中可以看到，inherit-product 函数除了会执行通过其参数传入的 Makefile 文件之外，还会额外做 3 件事：</span><br><span class="line">    1、继承通过参数传入的 Makefile 文件中的所有变量（A继承B）；</span><br><span class="line">    2、在 .INHERITS_FROM 变量中记录下这些继承关系；</span><br><span class="line">    3、在 ALL_PRODUCTS 变量中标识出当前操作的 Makefile 文件已经被访问过了（以免重复访问）</span><br></pre></td></tr></table></figure>


<h2 id="include-call-all-subdir-makefiles-和include-call-all-makefiles-under-LOCAL-PATH-区别"><a href="#include-call-all-subdir-makefiles-和include-call-all-makefiles-under-LOCAL-PATH-区别" class="headerlink" title="include $(call all-subdir-makefiles)和include $(call all-makefiles-under,$(LOCAL_PATH))区别"></a>include $(call <code>all-subdir-makefiles</code>)和include $(call <code>all-makefiles-under</code>,$(LOCAL_PATH))区别</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">include $(call all-subdir-makefiles)是直接包含子目录，不管当前目录</span><br><span class="line">    当一级的内容是include $(call all-subdir-makefiles)时候，$(LOCAL_PATH)指向的还是一级目录的路径</span><br><span class="line">include $(call all-makefiles-under,$(LOCAL_PATH))是包含子目录和当前目录</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcdn.net/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>