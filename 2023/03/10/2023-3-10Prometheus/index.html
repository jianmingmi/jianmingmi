<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="&lt;p&gt;Prometheus&lt;/p&gt;"><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><title>Prometheus | Mijm Blog</title><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Hexo 6.3.0"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-none-link" href="/tags/Linux/" rel="tag">Linux</a></div><div class="post-time">2023-03-10</div></div></div><div class="container post-header"><h1>Prometheus</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">docker安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%8C%85%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">软件包安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8prometheus"><span class="toc-number">2.1.</span> <span class="toc-text">启动prometheus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8node-exporter"><span class="toc-number">2.2.</span> <span class="toc-text">启动node_exporter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9"><span class="toc-number">2.3.</span> <span class="toc-text">添加节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85grafana"><span class="toc-number">2.4.</span> <span class="toc-text">安装grafana</span></a></li></ol></li></ol></details></div><div class="container post-content"><p>Prometheus</p>
<span id="more"></span>

<h2 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim docker-compose.yml</span><br><span class="line">    version: &quot;3.7&quot;</span><br><span class="line">    services:</span><br><span class="line">      prometheus_node_exporter:</span><br><span class="line">        image: prom/node-exporter:latest</span><br><span class="line">        container_name: &quot;prometheus_node_exporter&quot;</span><br><span class="line">        ports:</span><br><span class="line">          - &quot;9100:9100&quot;</span><br><span class="line">        restart: always</span><br><span class="line"></span><br><span class="line">      prometheus:</span><br><span class="line">        image: prom/prometheus:latest</span><br><span class="line">        container_name: &quot;prometheus&quot;</span><br><span class="line">        restart: always</span><br><span class="line">        ports:</span><br><span class="line">          - &quot;9090:9090&quot;</span><br><span class="line">        volumes:</span><br><span class="line">          - &quot;./prometheus.yml:/etc/prometheus/prometheus.yml&quot;</span><br><span class="line">          - &quot;./prometheus_data:/prometheus&quot;</span><br><span class="line"></span><br><span class="line">      grafana:</span><br><span class="line">        image: grafana/grafana</span><br><span class="line">        container_name: &quot;grafana&quot;</span><br><span class="line">        ports:</span><br><span class="line">          - &quot;3000:3000&quot;</span><br><span class="line">        restart: always</span><br><span class="line"></span><br><span class="line">1.备份出/etc/prometheus/prometheus.yml 到 prometheus.yml</span><br><span class="line">2.mkdir prometheus_data; chmod 777 prometheus_data</span><br><span class="line">3.添加node_exporter节点</span><br><span class="line">4.grafana添加数据源，初始账号密码：admin、admin</span><br><span class="line">5.grafana添加模板：9276</span><br></pre></td></tr></table></figure>

<h2 id="软件包安装"><a href="#软件包安装" class="headerlink" title="软件包安装"></a>软件包安装</h2><h3 id="启动prometheus"><a href="#启动prometheus" class="headerlink" title="启动prometheus"></a>启动prometheus</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/</span><br><span class="line">sudo wget https://github.com/prometheus/prometheus/releases/download/v2.27.1/prometheus-2.27.1.linux-amd64.tar.gz</span><br><span class="line">sudo tar xf prometheus-2.27.1.linux-amd64.tar.gz</span><br><span class="line">sudo ln -s prometheus-2.27.1.linux-amd64 prometheus</span><br><span class="line">sudo chown -R root.root prometheus-2.27.1.linux-amd64</span><br><span class="line"></span><br><span class="line">sudo vim /lib/systemd/system/prometheus.service</span><br><span class="line">    [Unit]</span><br><span class="line">    Description=Prometheus server daemon</span><br><span class="line">    After=network.target</span><br><span class="line"></span><br><span class="line">    [Service]</span><br><span class="line">    Type=simple</span><br><span class="line">    User=root</span><br><span class="line">    Group=root</span><br><span class="line">    ExecStart=&quot;/usr/local/prometheus/prometheus&quot; --config.file=&quot;/usr/local/prometheus/prometheus.yml&quot; --storage.tsdb.path=&quot;/usr/local/prometheus/data&quot; --storage.tsdb.retention=5d --web.console.templates=&quot;/usr/local/prometheus/consoles&quot; --web.console.libraries=&quot;/usr/local/prometheus/console_libraries&quot; --web.max-connections=512 --web.external-url=&quot;http://192.168.33.20:9090&quot; --web.listen-address=&quot;0.0.0.0:9090&quot;Restart=on-failure</span><br><span class="line"></span><br><span class="line">    [Install]</span><br><span class="line">    WantedBy=multi-user.target</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart prometheus.service</span><br><span class="line">sudo systemctl status prometheus.service</span><br></pre></td></tr></table></figure>

<h3 id="启动node-exporter"><a href="#启动node-exporter" class="headerlink" title="启动node_exporter"></a>启动node_exporter</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">sudo wget https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">sudo tar xf node_exporter-1.1.2.linux-amd64.tar.gz</span><br><span class="line">sudo ln -s node_exporter-1.1.2.linux-amd64 node_exporter</span><br><span class="line">sudo chown -R root.root node_exporter-1.1.2.linux-amd64</span><br><span class="line">sudo vim /lib/systemd/system/node_exporter.service</span><br><span class="line">    [Unit]</span><br><span class="line">    Description=node_exporter</span><br><span class="line">    Documentation=https://prometheus.io/</span><br><span class="line">    After=network.target</span><br><span class="line"></span><br><span class="line">    [Service]</span><br><span class="line">    Type=simple</span><br><span class="line">    ExecStart=/usr/local/node_exporter/node_exporter \</span><br><span class="line">    --collector.mountstats \</span><br><span class="line">    --collector.systemd \</span><br><span class="line">    --collector.ntp \</span><br><span class="line">    --collector.tcpstat</span><br><span class="line">    ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">    TimeoutStopSec=2s</span><br><span class="line">    Restart=always</span><br><span class="line"></span><br><span class="line">    [Install]</span><br><span class="line">    WantedBy=multi-user.target</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl start node_exporter.service</span><br><span class="line">sudo systemctl status node_exporter.service</span><br></pre></td></tr></table></figure>

<h3 id="添加节点"><a href="#添加节点" class="headerlink" title="添加节点"></a>添加节点</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /usr/local/prometheus/prometheus.yml</span><br><span class="line">    scrape_configs:</span><br><span class="line">      - job_name: &#x27;node_exporter&#x27;</span><br><span class="line">        scrape_interval: 5s</span><br><span class="line">        static_configs:</span><br><span class="line">        - targets: [&#x27;192.168.33.20:9100&#x27;]</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart prometheus.service</span><br><span class="line">sudo systemctl status prometheus.service</span><br></pre></td></tr></table></figure>

<h3 id="安装grafana"><a href="#安装grafana" class="headerlink" title="安装grafana"></a>安装grafana</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.grafana.com/enterprise/release/grafana-enterprise_8.3.3_amd64.deb</span><br><span class="line">sudo dpkg -i grafana-enterprise_8.3.3_amd64.deb</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl start grafana-server</span><br><span class="line">sudo systemctl status grafana-server</span><br><span class="line">sudo systemctl enable grafana-server.service（开机启动）</span><br><span class="line">sudo grafana-cli admin reset-admin-password &quot;admin&quot;（初始化admin密码）</span><br><span class="line"></span><br><span class="line">1.添加prometheus数据源</span><br><span class="line">2.添加仪表盘：9276（搜寻仪表盘：https://grafana.com/grafana/dashboards/9276-1-cpu/）</span><br></pre></td></tr></table></figure></div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/lato-font/3.0.0/css/lato-font.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcdn.net/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcdn.net/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>